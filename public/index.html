<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Artists Directory</title>
<style>
  body{margin:0;font-family:system-ui;background:#0f1115;color:#e8ecf1}
  header{padding:20px;border-bottom:1px solid #222938;background:linear-gradient(180deg,#141823,#0f1115);position:sticky;top:0}
  h1{margin:0 0 10px;font-size:1.4rem}
  .controls{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .control{display:flex;flex-direction:column;gap:6px;min-width:160px;flex:1}
  label{font-size:.83rem;color:#9aa3ad}
  input,select,button{padding:10px 12px;border:1px solid #222938;border-radius:10px;background:#151922;color:#e8ecf1}
  input:focus,select:focus,button:focus{outline:none;border-color:#6ea8fe;box-shadow:0 0 0 3px #6ea8fe22}
  .badge{background:#1b2230;color:#9aa3ad;padding:6px 10px;border-radius:999px;font-size:.78rem;border:1px solid #222938}
  main{max-width:1100px;margin:18px auto;padding:0 16px 50px}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
  .card{background:#151922;border:1px solid #222938;border-radius:14px;padding:14px;display:flex;gap:12px;justify-content:space-between}
  .left{display:flex;gap:12px}
  .avatar{width:40px;height:40px;border-radius:10px;background:#1b2230;display:grid;place-items:center;color:#c8d3e0;font-weight:600;border:1px solid #222938}
  .meta{display:flex;flex-direction:column;gap:4px;min-width:0}
  .name{font-weight:650}
  .pill{font-size:.72rem;padding:3px 8px;border-radius:999px;border:1px solid #222938;background:#111522;color:#cbd5e1}
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:#9aa3ad;font-size:.85rem}
  .hidden{display:none!important}
</style>

<header>
  <h1>Artists Directory</h1>
  <div class="controls">
    <div class="row">
      <div class="control" style="flex:2">
        <label for="q">Search by name</label>
        <input id="q" placeholder="Type to search…" autocomplete="off">
      </div>
      <div class="control">
        <label for="type">Artist Type</label>
        <select id="type" multiple size="4"></select>
      </div>
      <div class="control">
        <label for="country">Country</label>
        <select id="country" multiple size="6"></select>
      </div>
    </div>
    <div class="row" style="align-items:center">
      <span class="badge" id="count">0 shown</span>
      <span class="badge" id="active">No filters</span>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="clear">Clear</button>
        <button id="export">Export CSV</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div id="grid" class="grid" role="list"></div>
  <div id="empty" class="hidden" style="margin-top:20px;color:#cbd5e1">No results.</div>
  <div class="footer"><div>Tip: Hold Ctrl/⌘ to select multiple.</div><div>v3.0</div></div>
</main>

<script>
const els = {
  q: q('#q'), type: q('#type'), country: q('#country'),
  grid: q('#grid'), count: q('#count'), active: q('#active'), empty: q('#empty'),
  clear: q('#clear'), exportBtn: q('#export')
};
function q(s){return document.querySelector(s)}
function selected(sel){return Array.from(sel.selectedOptions).map(o=>o.value)}
function uniq(a){return [...new Set(a.filter(Boolean))].sort((x,y)=>x.localeCompare(y))}
function initials(n){return (n||'').split(/\s+/).slice(0,2).map(w=>w[0]?.toUpperCase()||'').join('')}
function card(r){
  const el=document.createElement('article'); el.className='card'; el.setAttribute('role','listitem');
  el.innerHTML = `
    <div class="left">
      <div class="avatar">${initials(r.name)}</div>
      <div class="meta">
        <div class="name">${r.name}</div>
        <div>${r.country||'—'}</div>
        <div style="margin-top:4px">${r.type?`<span class="pill">${r.type}</span>`:''} ${r.igExtract?`<span class="pill">@${r.igExtract}</span>`:''}</div>
      </div>
    </div>
    <div>${r.link?`<a href="${r.link}" target="_blank" rel="noopener" class="pill" style="text-decoration:none;display:inline-block">Link</a>`:''}</div>`;
  return el;
}
function fillSelect(sel, arr, placeholder){
  sel.innerHTML='';
  if(!arr.length){const o=document.createElement('option');o.textContent=`No ${placeholder}`;o.disabled=true;sel.appendChild(o);return;}
  arr.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;sel.appendChild(o);});
}
async function loadAll(){
  const res = await fetch('/api/artists?limit=1000');
  const data = await res.json();
  const rows = data.results||[];
  fillSelect(els.type, uniq(rows.map(r=>r.type)), 'types');
  fillSelect(els.country, uniq(rows.map(r=>r.country)), 'countries');
  render(rows);
}
async function applyFilters(){
  const url = new URL('/api/artists', location.origin);
  const qv = els.q.value.trim(); if(qv) url.searchParams.set('q', qv);
  selected(els.type).forEach(v=>url.searchParams.append('type', v));
  selected(els.country).forEach(v=>url.searchParams.append('country', v));
  url.searchParams.set('limit', '300');
  const {results=[]} = await (await fetch(url)).json();
  render(results);
}
function render(rows){
  const sorted = rows.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  els.grid.innerHTML=''; sorted.forEach(r=>els.grid.appendChild(card(r)));
  els.count.textContent = `${sorted.length} shown`;
  els.empty.classList.toggle('hidden', sorted.length>0);
  const bits=[];
  if(els.q.value.trim()) bits.push(`name has “${els.q.value.trim()}”`);
  if(selected(els.type).length) bits.push(`type: ${selected(els.type).length}`);
  if(selected(els.country).length) bits.push(`country: ${selected(els.country).length}`);
  els.active.textContent = bits.length?bits.join(' · '):'No filters';
}
function exportCSV(rows){
  const headers = ['name','type','country','igExtract','link'];
  const csv = [headers.join(',')].concat(
    rows.map(r=>headers.map(h=>`"${String(r[h]??'').replace(/"/g,'""')}"`).join(','))
  ).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='artists_filtered.csv'; a.click(); URL.revokeObjectURL(a.href);
}
els.q.addEventListener('input', ()=>{clearTimeout(window._t); window._t=setTimeout(applyFilters,160)});
[els.type, els.country].forEach(s=>s.addEventListener('change', applyFilters));
els.clear.addEventListener('click', ()=>{els.q.value=''; [els.type,els.country].forEach(s=>Array.from(s.options).forEach(o=>o.selected=false)); applyFilters();});
els.exportBtn.addEventListener('click', async ()=>{
  const {results=[]}=await (await fetch('/api/artists?limit=1000')).json(); exportCSV(results);
});
loadAll(); // auto-load on page open
</script>
</html>